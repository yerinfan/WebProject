<body>
  <h2>얼굴로 로그인</h2>
  <video id="video" autoplay width="300"></video>
  <canvas id="canvas" style="display: none;"></canvas>

  <div id="failMessage" style="display:none; color:red;">
    얼굴을 인식하지 못했습니다.<br>
    <a href="/login">아이디와 비밀번호로 로그인하기</a>
  </div>

<script>
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      document.getElementById('video').srcObject = stream;
      startFaceRecognition();  // 웹캠이 열리면 얼굴 인식 시작
    })
    .catch(err => {
      alert("웹캠 오류: " + err.message);
    });

  let matched = false;
  let failTimeout;

  const startFaceRecognition = () => {
    const canvas = document.getElementById("canvas");
    const video = document.getElementById("video");

    const intervalId = setInterval(() => {
      if (matched) {
        clearInterval(intervalId);
        return;
      }

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0);
      const imageData = canvas.toDataURL("image/jpeg");

      fetch("/login/face", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image: imageData })
      })
      .then(async res => {
        const contentType = res.headers.get("content-type");
        if (!res.ok || !contentType || !contentType.includes("application/json")) {
          throw new Error("서버 응답 오류: JSON 형식이 아닙니다");
        }
        return res.json();
      })
      .then(data => {
        if (data.success) {
          matched = true;
          window.location.href = "/rooms";
        }
      })
      .catch(err => {
        console.error("❌ 얼굴 로그인 오류:", err);
        // 서버 오류 등으로 중단 시도 가능
        clearInterval(intervalId);
        document.getElementById("failMessage").style.display = "block";
      });
    }, 1000);

    failTimeout = setTimeout(() => {
      if (!matched) {
        clearInterval(intervalId);
        document.getElementById("failMessage").style.display = "block";
      }
    }, 10000); // 10초 후 실패 메시지 출력
  };
</script>

</body>
