<script>
  const video = document.getElementById('video');
  const startBtn = document.getElementById('startBtn');
  const statusDiv = document.getElementById('status');
  const totalFaces = 3;
  let faceCount = 0;
  const images = [];

  // ✅ 여기 수정!
  const flaskBaseUrl = 'https://7c62cbc8-2887-4b96-81b2-b9603ea54eec-00-fishgerrldgj.pike.replit.dev';

  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      video.srcObject = stream;
    })
    .catch(err => {
      alert('카메라 사용 불가: ' + err);
    });

  function checkFace(imageData) {
    return fetch(`${flaskBaseUrl}/face/check`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image: imageData })
    })
    .then(res => res.json())
    .then(data => data.hasFace);
  }

  async function captureAndSend(username) {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth || 320;
    canvas.height = video.videoHeight || 240;
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

    const imageData = canvas.toDataURL('image/jpeg');

    const hasFace = await checkFace(imageData);
    if (!hasFace) {
      statusDiv.innerText = "얼굴이 감지되지 않았습니다. 다시 시도 중...";
      setTimeout(() => captureAndSend(username), 1000);
      return;
    }

    images.push(imageData);
    faceCount++;
    statusDiv.innerText = `${faceCount}장 수집됨`;

    if (faceCount >= totalFaces) {
      statusDiv.innerText = "서버에 등록 중...";

      fetch(`${flaskBaseUrl}/register-face`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ username, images })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          statusDiv.innerText = "등록 성공!";
          setTimeout(() => window.location.href = "/rooms", 1500);
        } else {
          statusDiv.innerText = "등록 실패: " + data.message;
        }
      })
      .catch(err => {
        statusDiv.innerText = "서버 오류: " + err;
      });
    } else {
      setTimeout(() => captureAndSend(username), 1000);
    }
  }

  startBtn.addEventListener('click', () => {
    faceCount = 0;
    images.length = 0;
    statusDiv.innerText = "촬영 시작...";
    captureAndSend(username);
  });
</script>
