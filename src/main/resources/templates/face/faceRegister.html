<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>ì–¼êµ´ ë“±ë¡</title>
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  <style>
    video {
      width: 320px;
      height: 240px;
      border: 1px solid black;
      display: block;
      background-color: black;
    }

    #status {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>ì–¼êµ´ ë“±ë¡</h2>
  <p>ì¹´ë©”ë¼ë¥¼ ì‘ì‹œí•´ ì£¼ì„¸ìš”. ì–¼êµ´ 3ì¥ì„ ìë™ìœ¼ë¡œ ìˆ˜ì§‘í•©ë‹ˆë‹¤.</p>

  <video id="video" autoplay muted playsinline></video>
  <br />
  <button id="startBtn">ë“±ë¡ ì‹œì‘</button>
  <div id="status"></div>
  <br />
  <a th:href="@{/rooms}">â† ì±„íŒ…ë°© ëª©ë¡ìœ¼ë¡œ</a>

  <!-- Thymeleafì—ì„œ ì‚¬ìš©ìëª… ë° CSRF í† í° ì£¼ì… -->
  <script th:inline="javascript">
    const username = [[${#authentication.name}]];
    const csrfToken = /*[[${_csrf.token}]]*/ "";
    const csrfHeader = /*[[${_csrf.headerName}]]*/ "";
  </script>

  <script>
    const video = document.getElementById('video');
    const startBtn = document.getElementById('startBtn');
    const statusDiv = document.getElementById('status');
    const totalFaces = 3;
    let faceCount = 0;
    const images = [];

    const flaskBaseUrl = 'https://7c62cbc8-2887-4b96-81b2-b9603ea54eec-00-fishgerrldgj.pike.replit.dev';

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play();
          console.log("ğŸ“· video loaded:", video.videoWidth, video.videoHeight);
        };
      })
      .catch(err => {
        alert('ì¹´ë©”ë¼ ì‚¬ìš© ë¶ˆê°€: ' + err);
      });

    function checkFace(imageData) {
      return fetch(`${flaskBaseUrl}/face/check`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image: imageData })
      })
      .then(res => res.json())
      .then(data => data.hasFace);
    }

    async function captureAndSend(username) {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth || 320;
      canvas.height = video.videoHeight || 240;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const imageData = canvas.toDataURL('image/jpeg');
      console.log("ğŸ“¸ ìº¡ì²˜ëœ ì´ë¯¸ì§€ í¬ê¸°:", canvas.width, canvas.height);

      const hasFace = await checkFace(imageData);
      if (!hasFace) {
        statusDiv.innerText = "ì–¼êµ´ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„ ì¤‘...";
        setTimeout(() => captureAndSend(username), 1000);
        return;
      }

      images.push(imageData);
      faceCount++;
      statusDiv.innerText = `${faceCount}ì¥ ìˆ˜ì§‘ë¨`;

      if (faceCount >= totalFaces) {
        statusDiv.innerText = "ì„œë²„ì— ë“±ë¡ ì¤‘...";

        fetch(`${flaskBaseUrl}/register-face`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, images })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            statusDiv.innerText = "ë“±ë¡ ì„±ê³µ!";
            setTimeout(() => window.location.href = "/rooms", 1500);
          } else {
            statusDiv.innerText = "ë“±ë¡ ì‹¤íŒ¨: " + data.message;
          }
        })
        .catch(err => {
          statusDiv.innerText = "ì„œë²„ ì˜¤ë¥˜: " + err;
        });
      } else {
        setTimeout(() => captureAndSend(username), 1000);
      }
    }

    startBtn.addEventListener('click', () => {
      faceCount = 0;
      images.length = 0;
      statusDiv.innerText = "ì´¬ì˜ ì‹œì‘...";
      captureAndSend(username);
    });
  </script>
</body>
</html>
